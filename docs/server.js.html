<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const net = require("net");
const openpgp = require("openpgp");

const utils = require("./utils");
const chalk = require("chalk");

const aes = require("./aes");
const SecureConnection = require("./secure_connection");

/**
 * 
 * @param {SecsockCallback} listener The listener for when a connection is established
 * @param {number} port The port that the server will listen on
 * @param {string} hostname The hostname the server will listen on
 * 
 * @class
 */
function SecsockServer (listener, port, hostname = "0.0.0.0") {

	var server = net.createServer(socket => {

		var publicKey;
		var privateKey;
		var rsaPassphrase = utils.unique();

		var aesKey;

		utils.log(`Openpgp passphrase with length ${rsaPassphrase.length} successfully generated`);

		let options = {
			userIds: [{ name: "Auguste Rame", email: "identity@gigagamma.com" }],
			numBits: 512,
			passphrase: rsaPassphrase
		};

		openpgp.generateKey(options).then(key => {

			publicKey = key.publicKeyArmored;
			privateKey = key.privateKeyArmored;

			utils.log(`RSA keys successfully generated`);

			socket.write(publicKey);

		}).catch(reason => {

			throw reason;

		});

		var sc;

		socket.on("data", async data => {

			const privKeyObj = (await openpgp.key.readArmored(privateKey)).keys[0];
			await privKeyObj.decrypt(rsaPassphrase);

			if (!aesKey) {

				const options = {
					message: await openpgp.message.readArmored(data.toString()),
					publicKeys: (await openpgp.key.readArmored(publicKey)).keys,
					privateKeys: [privKeyObj]
				}

				openpgp.decrypt(options).then(plaintext => {

					aesKey = plaintext.data;

					utils.log("Secure Server -> Client connection established");

					sc = new SecureConnection(socket, aesKey);
					listener(sc);

				});

			} else {

				sc.process(data);

			}

		});

	});

	server.listen(port, hostname);

}

module.exports = SecsockServer;

/**
 * @callback SecsockCallback
 * @param {SecureConnection} secure
 */

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SecsockClient.html">SecsockClient</a></li><li><a href="SecsockServer.html">SecsockServer</a></li><li><a href="SecureConnection.html">SecureConnection</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Oct 16 2018 06:23:02 GMT+0300 (Middle East Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
